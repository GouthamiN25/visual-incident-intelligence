<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visual Incident Intelligence</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-4xl mx-auto p-8">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-xl font-bold">Visual Incident Intelligence</div>
        <div class="text-slate-400 text-sm">Sketch/Image → Risk Insight • Vector Search</div>
      </div>
      <div class="flex gap-2">
        <div class="px-3 py-1 rounded-full border border-slate-700 bg-slate-900 text-sm">
          System: <span id="sys">checking…</span>
        </div>
        <div class="px-3 py-1 rounded-full border border-slate-700 bg-slate-900 text-sm">
          Qdrant: <span id="qd">checking…</span>
        </div>
      </div>
    </div>

    <h1 class="text-5xl font-extrabold mt-10 text-cyan-300">Resolve Incidents Faster</h1>
    <p class="text-slate-300 mt-3">
      Upload a sketch, dashboard, or diagram. We’ll match it against past incidents and return evidence + actions.
    </p>

    <div class="mt-8 p-6 rounded-2xl border border-slate-800 bg-slate-900/40">
      <input id="file" type="file" accept="image/png,image/jpeg,image/webp" class="block w-full" />
      <textarea id="note" class="mt-3 w-full p-3 rounded-xl bg-slate-950 border border-slate-800"
        placeholder="Optional note: vpn down, auth failures, unusual outbound traffic"></textarea>

      <div class="mt-3 flex gap-3">
        <button id="seed" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">Seed Demo Incidents</button>
        <button id="go" class="px-4 py-2 rounded-xl bg-cyan-700 hover:bg-cyan-600 border border-cyan-500 font-semibold">Analyze & Match</button>
      </div>

      <div id="status" class="mt-3 text-sm text-slate-400"></div>
    </div>

    <div id="results" class="mt-6 hidden">
      <div class="text-lg font-bold">Matches</div>
      <div id="cards" class="grid md:grid-cols-2 gap-3 mt-3"></div>

      <div class="mt-6 p-5 rounded-2xl border border-slate-800 bg-slate-900/40">
        <div class="font-bold">Suggested Actions</div>
        <ul id="actions" class="mt-2 list-disc pl-5 text-slate-200"></ul>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "http://127.0.0.1:8000";
  const sys = document.getElementById("sys");
  const qd = document.getElementById("qd");
  const statusEl = document.getElementById("status");
  const fileEl = document.getElementById("file");
  const noteEl = document.getElementById("note");
  const seedBtn = document.getElementById("seed");
  const goBtn = document.getElementById("go");
  const results = document.getElementById("results");
  const cards = document.getElementById("cards");
  const actions = document.getElementById("actions");

  const setStatus = (t) => statusEl.textContent = t || "";

  async function health() {
    try {
      const r = await fetch(`${API_BASE}/health`);
      const j = await r.json();
      sys.textContent = j.api_ok ? "Operational" : "Down";
      qd.textContent = j.qdrant_ok ? "Connected" : "Not Connected";
    } catch {
      sys.textContent = "Down";
      qd.textContent = "Not Connected";
    }
  }
  health(); setInterval(health, 4000);

  async function ingest(file, note) {
    const fd = new FormData();
    fd.append("file", file);
    fd.append("note", note || "");
    const r = await fetch(`${API_BASE}/ingest`, { method:"POST", body: fd });
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function search(incident_id) {
    const r = await fetch(`${API_BASE}/search`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ incident_id, top_k: 5 })
    });
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  function render(res) {
    results.classList.remove("hidden");
    cards.innerHTML = "";
    (res.matches || []).forEach(m => {
      const div = document.createElement("div");
      div.className = "p-4 rounded-2xl border border-slate-800 bg-slate-900/40";
      div.innerHTML = `
        <div class="text-xs text-slate-400">Incident</div>
        <div class="text-sm break-all">${m.incident_id}</div>
        <div class="mt-2 text-cyan-300 font-bold">Score: ${Number(m.score).toFixed(3)}</div>
        <div class="mt-2 text-slate-200 text-sm">${m.incident_card?.summary || "—"}</div>
      `;
      cards.appendChild(div);
    });

    actions.innerHTML = "";
    (res.suggested_actions || []).forEach(a => {
      const li = document.createElement("li");
      li.textContent = a;
      actions.appendChild(li);
    });
  }

  seedBtn.onclick = async () => {
    try {
      seedBtn.disabled = true;
      setStatus("Seeding demo incidents…");

      // tiny blank png created in-browser
      const canvas = document.createElement("canvas");
      canvas.width = 16; canvas.height = 16;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#000"; ctx.fillRect(0,0,16,16);

      const notes = [
        "vpn down, auth failures, unusual outbound traffic",
        "5xx spike, api gateway latency, database connection timeout",
        "suspicious login burst, credential stuffing, WAF alerts",
        "dns anomalies, possible tunneling, high egress volume",
        "cpu spike on auth service, rate limit triggered"
      ];

      for (let i=0;i<notes.length;i++){
        const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
        const f = new File([blob], `seed_${i}.png`, {type:"image/png"});
        await ingest(f, notes[i]);
      }
      setStatus("Seed complete ✅ Upload any image and click Analyze & Match.");
    } catch (e) {
      setStatus("Seed error: " + e.message);
    } finally {
      seedBtn.disabled = false;
    }
  };

  goBtn.onclick = async () => {
    try {
      const f = fileEl.files?.[0];
      if (!f) return setStatus("Please choose an image first.");
      goBtn.disabled = true;
      setStatus("Ingesting…");
      const ing = await ingest(f, noteEl.value);
      setStatus("Searching…");
      const res = await search(ing.incident_id);
      render(res);
      setStatus("Done ✅");
    } catch (e) {
      setStatus("Analyze error: " + e.message);
    } finally {
      goBtn.disabled = false;
    }
  };
</script>
</body>
</html>
